<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Cart√£o BINGO PICS</title>

    <!-- Estilos CSS -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #e6f0f7, #ffffff);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            box-sizing: border-box;
        }

        h1 {
            color: #007bff;
            text-align: center;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        #main-game-area {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            max-width: 1200px;
            gap: 30px;
        }


        .player-card-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
            flex-grow: 0;
        }

        .player-card-container button {
             display: block;
             width: auto;
             min-width: 200px;
             padding: 12px 25px;
             font-size: 1.1em;
             font-weight: bold;
             cursor: pointer;
             border: none;
             border-radius: 8px;
             color: white;
             background: linear-gradient(135deg, #007bff, #0056b3);
             box-shadow: 0 4px 6px rgba(0,0,0,0.1);
             transition: transform 0.2s ease, background-color 0.3s ease;
             margin-bottom: 0;
             text-align: center;
        }

         .player-card-container button:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #0056b3, #004099);
         }


        .card-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .card-cell {
            background: linear-gradient(145deg, #cfe7f9, #a8d2f0);
            border: 2px solid #007bff;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.75em;
            font-weight: bold;
            padding: 6px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s, transform 0.2s, border-color 0.3s, color 0.3s, box-shadow 0.3s;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            overflow-wrap: break-word;
            word-break: break-word;
            color: #333;
            position: relative;
            line-height: 1.2;
        }

         .card-cell:not(.marked):hover {
            transform: scale(1.05);
             background-color: #87ceeb;
             border-color: #0056b3;
        }

        .card-cell.marked {
             color: white;
             text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
             box-shadow: 0 0 10px rgba(0,0,0,0.3);
             background-image: none;
             cursor: default;
             transform: none !important;
         }


        /* --- Marked PICS Sidebar Styles with Accordion --- */
        #marked-pics-sidebar { /* Changed ID back */
            width: 350px; /* Restored previous width */
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            /* Following user's explicit instruction to disable overflow/max-height */
            overflow-y: hidden !important;
            max-height: none !important;
            flex-shrink: 0;
            flex-grow: 0;
            position: sticky; /* Keep sticky positioning */
            top: 20px;
            display: flex;
            flex-direction: column;
        }

         #marked-pics-sidebar h2 { /* Changed ID back */
            color: #0056b3;
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
         }

        /* NOVO estilo para accordion */
        #marked-pics-list { /* Changed ID back */
            display: flex;
            flex-direction: column;
            gap: 8px;
             /* Remove grid styles */
             /* Add scroll if the list gets too long and sidebar max-height was active */
             /* With max-height: none on sidebar, this overflow might not be needed */
             overflow-y: visible; /* Or auto if sidebar max-height was kept */
             padding-right: 0; /* Remove padding if no internal scrollbar */
        }

        .accordion-item {
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            border-left: 5px solid #007bff; /* Color set by JS */
            transition: all 0.3s ease;
            overflow: hidden; /* Hide content when collapsed */
        }

         .accordion-item:last-child {
             margin-bottom: 0; /* No gap after the last item */
         }


        .accordion-header {
            padding: 10px 15px;
            font-weight: bold;
            cursor: pointer;
            color: #333;
            transition: background-color 0.2s;
            word-break: break-word; /* Allow breaking long names */
        }

        .accordion-header:hover {
            background-color: #f0f0f0;
        }

        .accordion-content {
            display: none; /* Hidden by default */
            padding: 0 15px 10px 15px;
            font-size: 0.9em;
            color: #555;
            line-height: 1.4;
            word-break: break-word; /* Allow breaking long descriptions */
        }

        .accordion-item.active .accordion-content {
            display: block; /* Shown when active */
        }


        /* --- Expanded View (Modal) Styles - KEPT THE SAME --- */
        #expanded-view-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #expanded-card-container {
            width: 90%;
            max-width: 400px;
            height: 65vh;
            max-height: 550px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            perspective: 1000px;
            overflow: hidden;
            cursor: pointer;
        }

         #expanded-card-container .flip-container {
             flex-grow: 1;
             width: 100%;
             margin-bottom: 15px;
        }


        #close-expanded-view {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: rgba(255, 255, 255, 0.8);
            color: #333;
            font-size: 1.5em;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1010;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
             border: none;
             padding: 0;
             transition: background-color 0.2s;
        }

         #close-expanded-view:hover {
            background-color: #eee;
         }

         #mark-button {
            display: block;
            width: 80%;
            padding: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: white;
            background-color: #28a745;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease;
            text-align: center;
            z-index: 1005;
         }

         #mark-button:hover:not(:disabled) {
             background-color: #218838;
             transform: translateY(-1px);
         }

          #mark-button:disabled {
            background-color: #cccccc !important;
            cursor: not-allowed;
            box-shadow: none;
            color: #666;
            transform: none !important;
         }

        .flip-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .flipper {
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
        }

        .flip-container.flipped .flipper {
            transform: rotateY(180deg);
        }

        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .front {
            background-color: #e0f7fa;
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
            border-width: 3px;
            border-style: solid;
            line-height: 1.3;
        }

        .back {
            background-color: #fff;
            color: #333;
            font-size: 1.1em;
            text-align: left;
            border: 1px solid #ccc;
            transform: rotateY(180deg);
             line-height: 1.5;
        }


        /* --- Responsive Styles --- */
        @media (max-width: 1000px) {
             #main-game-area {
                flex-direction: column;
                align-items: center;
                gap: 30px;
             }

             .player-card-container {
                 width: 100%;
                 max-width: 450px;
             }

             #marked-pics-sidebar { /* Changed ID back */
                 width: 100%;
                 max-width: 450px; /* Limit sidebar max width */
                 position: static;
                 max-height: none;
                 overflow-y: visible; /* Or auto if preferred */
                 flex-direction: column;
             }

             #marked-pics-list { /* Changed ID back */
                 gap: 8px; /* Keep gap */
             }

             .accordion-item {
                 border-left-width: 5px; /* Keep border width */
             }
        }


        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 2em;
                margin-bottom: 15px;
            }

             #main-game-area {
                 gap: 20px;
             }

             .player-card-container button {
                 width: 100%;
                 min-width: auto;
                 font-size: 1em;
                 padding: 10px 20px;
             }

            .card-grid {
                max-width: 320px;
                gap: 3px;
            }

            .card-cell {
                font-size: 0.6em;
                padding: 3px;
            }

             #marked-pics-sidebar { /* Changed ID back */
                 padding: 15px;
                 max-width: 320px;
             }

              #marked-pics-sidebar h2 { /* Changed ID back */
                 font-size: 1.3em;
                 margin-bottom: 10px;
                 padding-bottom: 8px;
              }

            .accordion-header {
                padding: 8px 10px; /* Adjusted padding */
                font-size: 0.9em; /* Adjusted font size */
            }

            .accordion-content {
                padding: 0 10px 8px 10px; /* Adjusted padding */
                font-size: 0.85em; /* Adjusted font size */
            }


             #expanded-card-container {
                width: 95%;
                height: 75vh;
                padding: 15px;
             }

             .front {
                font-size: 1.5em;
                padding: 15px;
             }

             .back {
                font-size: 1em;
                padding: 15px;
             }

             #mark-button {
                 width: 90%;
                 font-size: 1em;
                 padding: 8px;
             }
        }
    </style>
</head>
<body>
    <h1>BINGO das PICS do SUS</h1>

    <div id="main-game-area">
        <!-- Left side: Bingo Card area -->
        <div class="player-card-container">
            <button id="restart-button">Gerar Novo Cart√£o</button>
            <div id="bingo-card" class="card-grid">
                <!-- Card cells will be generated here -->
            </div>
        </div>

        <!-- Right side: Marked PICS Sidebar with Accordion -->
        <div id="marked-pics-sidebar"> <!-- Changed ID back -->
            <h2>PICS Marcadas</h2> <!-- Changed title back -->
            <div id="marked-pics-list"> <!-- Changed ID back -->
                <!-- Marked PICS accordion items will be listed here -->
            </div>
        </div>
    </div>


    <!-- Expanded View Overlay (Modal) - KEPT THE SAME -->
    <div id="expanded-view-overlay" style="display: none;">
        <div id="expanded-card-container">
             <button id="close-expanded-view">√ó</button>
            <div class="flip-container" id="flip-container">
                <div class="flipper" id="flipper">
                    <div class="front" id="expanded-front">
                        <!-- PICS Name -->
                    </div>
                    <div class="back" id="expanded-back">
                        <!-- PICS Description -->
                    </div>
                </div>
            </div>
             <button id="mark-button"></button>
        </div>
    </div>

    <script>
        // Lista das 29 PICS do SUS com descri√ß√µes (completa) - KEPT THE SAME
        const allPicsData = [
            { name: "Acupuntura", description: "T√©cnica milenar chinesa que insere agulhas em pontos espec√≠ficos do corpo para estimular o fluxo de energia e tratar diversas condi√ß√µes f√≠sicas e mentais." },
            { name: "Homeopatia", description: "Sistema m√©dico que utiliza subst√¢ncias naturais em doses m√≠nimas e altamente dilu√≠das para estimular a cura natural do corpo, baseado no princ√≠pio 'semelhante cura semelhante'." },
            { name: "Fitoterapia", description: "Uso de plantas medicinais em suas diferentes formas (ch√°s, extratos, c√°psulas) para preven√ß√£o, tratamento e al√≠vio de doen√ßas, aproveitando seus princ√≠pios ativos." },
            { name: "Termalismo Social/Crenoterapia", description: "Utiliza√ß√£o de √°guas minerais com propriedades terap√™uticas, associada a banhos, duchas e ingest√£o, em balne√°rios e est√¢ncias termais para tratamento de sa√∫de e bem-estar." },
            { name: "Antroposofia Aplicada √† Sa√∫de", description: "Abordagem integrativa que considera o ser humano em seus aspectos f√≠sico, vital, an√≠mico e espiritual. Utiliza medicamentos antropos√≥ficos, terapias art√≠sticas, massagens, entre outros." },
            { name: "Dan√ßa Circular", description: "Pr√°tica coletiva que utiliza dan√ßas em roda com movimentos e gestos significativos, promovendo socializa√ß√£o, bem-estar f√≠sico e mental, e conex√£o com tradi√ß√µes culturais." },
            { name: "Medita√ß√£o", description: "T√©cnica de concentra√ß√£o e relaxamento que treina a mente para focar a aten√ß√£o, promovendo redu√ß√£o do estresse, aumento da autoconsci√™ncia e equil√≠brio emocional." },
            { name: "Musicoterapia", description: "Uso da m√∫sica e seus elementos (som, ritmo, melodia, harmonia) por um musicoterapeuta qualificado para facilitar a comunica√ß√£o, o relacionamento, o aprendizado, a mobiliza√ß√£o, a express√£o e outros objetivos terap√™uticos." },
            { name: "Naturopatia", description: "Sistema que enfatiza a cura natural do corpo, utilizando terapias como fitoterapia, nutri√ß√£o, hidroterapia, argiloterapia, geoterapia, entre outras, visando a sa√∫de integral." },
            { name: "Osteopatia", description: "M√©todo diagn√≥stico e terap√™utico manual que busca restabelecer a fun√ß√£o das estruturas corporais (m√∫sculos, articula√ß√µes, ligamentos), visando aliviar dores e melhorar a mobilidade." },
            { name: "Quiropraxia", description: "Profiss√£o da √°rea da sa√∫de que se dedica ao diagn√≥stico, tratamento e preven√ß√£o de dist√∫rbios do sistema neuromusculoesquel√©tico, principalmente da coluna vertebral, utilizando ajustes manuais." },
            { name: "Reflexoterapia", description: "T√©cnica que estimula pontos reflexos em p√©s, m√£os ou orelhas, correspondentes a √≥rg√£os e sistemas do corpo, visando promover relaxamento, al√≠vio da dor e equil√≠brio energ√©tico." },
            { name: "Reiki", description: "Pr√°tica de imposi√ß√£o de m√£os que utiliza a 'energia vital universal' para equilibrar os centros de energia do corpo, promovendo relaxamento, bem-estar e aux√≠lio no processo de cura." },
            { name: "Shantala", description: "T√©cnica milenar indiana de massagem em beb√™s, realizada pelos pais ou cuidadores, que promove v√≠nculo afetivo, relaxamento, al√≠vio de c√≥licas e est√≠mulo ao desenvolvimento." },
            { name: "Terapia Comunit√°ria Integrativa", description: "Espa√ßo de escuta e acolhimento em grupo que busca fortalecer os la√ßos comunit√°rios, compartilhar experi√™ncias e saberes para superar sofrimentos, usando recursos da pr√≥pria comunidade e PICS." },
            { name: "Yoga", description: "Pr√°tica ancestral indiana que integra posturas f√≠sicas (asanas), exerc√≠cios respirat√≥rios (pranayama), medita√ß√£o e princ√≠pios √©ticos, promovendo equil√≠brio entre corpo e mente, flexibilidade e for√ßa." },
            { name: "Arteterapia", description: "Uso de materiais art√≠sticos e do processo criativo como forma de express√£o terap√™utica, auxiliando na resolu√ß√£o de conflitos, desenvolvimento pessoal e reabilita√ß√£o." },
            { name: "Ayurveda", description: "Sistema tradicional indiano de sa√∫de que busca equilibrar corpo, mente e esp√≠rito por meio de dieta, fitoterapia, massagens, yoga, medita√ß√£o e outras pr√°ticas personalizadas de acordo com o 'dosha' individual." },
            { name: "Biodan√ßa", description: "Sistema que utiliza m√∫sica, movimento e viv√™ncias em grupo para estimular a integra√ß√£o humana, o desenvolvimento das potencialidades e a express√£o dos afetos." },
            { name: "Bioenerg√©tica", description: "Abordagem terap√™utica corporal que combina an√°lise do car√°ter e t√©cnicas corporais (exerc√≠cios bioenerg√©ticos, massagens) para liberar tens√µes musculares e bloqueios emocionais, resgatando a vitalidade." },
            { name: "Constela√ß√£o Familiar", description: "M√©todo terap√™utico que explora as din√¢micas ocultas nos sistemas familiares e outros grupos, buscando identificar emaranhamentos e encontrar solu√ß√µes para conflitos e padr√µes limitantes." },
            { name: "Cromoterapia", description: "Uso das cores e suas vibra√ß√µes energ√©ticas para restaurar o equil√≠brio f√≠sico, energ√©tico e emocional do corpo." },
            { name: "Geoterapia", description: "Uso de elementos da terra como argila, lama, pedras e cristais para fins terap√™uticos, aplicada em cataplasmas, compressas, banhos e massagens, promovendo desintoxica√ß√£o e revitaliza√ß√£o." },
            { name: "Hipnoterapia", description: "Uso da hipnose como ferramenta terap√™utica para acessar o subconsciente, ressignificar traumas, tratar fobias, ansiedade e promover mudan√ßas comportamentais." },
            { name: "Imposi√ß√£o de M√£os", description: "Pr√°tica terap√™utica onde o toque ou a proximidade das m√£os busca transmitir energia vital para o receptor, promovendo relaxamento, al√≠vio da dor e aux√≠lio na recupera√ß√£o." },
            { name: "Ozonioterapia", description: "Uso terap√™utico do g√°s oz√¥nio, uma forma de oxig√™nio, aplicado por diversas vias para tratar infec√ß√µes, inflama√ß√µes, melhorar a circula√ß√£o e auxiliar na cicatriza√ß√£o." },
            { name: "Terapia de Florais", description: "Uso de ess√™ncias energ√©ticas extra√≠das de flores para atuar nos estados emocionais e mentais, buscando reequilibrar as emo√ß√µes e promover bem-estar ps√≠quico." },
             { name: "Aromaterapia", description: "Uso terap√™utico de √≥leos essenciais arom√°ticos extra√≠dos de plantas para promover sa√∫de f√≠sica e mental, aplicados por inala√ß√£o, massagem ou em banhos." },
            { name: "Apiterapia", description: "Uso de produtos das abelhas, como mel, p√≥len, pr√≥polis, geleia real e veneno (apitoxina), para fins terap√™uticos." }
        ];

        // Array of distinct colors (at least 29) - KEPT THE SAME
        const picsColors = [
            '#FF6347', '#4682B4', '#8A2BE2', '#3CB371', '#FFD700',
            '#FF69B4', '#00CED1', '#BA55D3', '#7CFC00', '#FF8C00',
            '#00FA9A', '#4169E1', '#DC143C', '#00BFFF', '#800080',
            '#32CD32', '#FF4500', '#1E90FF', '#DA70D6', '#9ACD32',
            '#FFA07A', '#6495ED', '#DDA0DD', '#556B2F', '#CD853F',
            '#20B2AA', '#87CEEB', '#FFB6C1', '#9370DB'
        ];

        let playerCard = []; // Stores objects { name, description, marked, element, row, col }
        let picsColorMap = {};

        let completedPatterns = [];

        // DOM Elements - UPDATED sidebar element reference
        const cardGridElement = document.getElementById('bingo-card');
        const restartButton = document.getElementById('restart-button');
        const expandedViewOverlay = document.getElementById('expanded-view-overlay');
        const expandedCardContainer = document.getElementById('expanded-card-container');
        const closeExpandedViewButton = document.getElementById('close-expanded-view');
        const flipper = document.getElementById('flipper');
        const expandedFront = document.getElementById('expanded-front');
        const expandedBack = document.getElementById('expanded-back');
        const flipContainer = document.getElementById('flip-container');
        const markButton = document.getElementById('mark-button');

        // New DOM Element reference for the marked list (accordion container)
        const markedPicsListElement = document.getElementById('marked-pics-list');


        let isExpandedViewOpen = false;
        let currentExpandedCardItem = null;

        // --- Card Generation --- - MODIFIED
        function generateCard() {
            const cardSize = 25;
            playerCard = [];
            cardGridElement.innerHTML = ''; // Clear grid display
            markedPicsListElement.innerHTML = ''; // <-- Clear marked list (accordion) on new card
            completedPatterns = [];

            // Populate color map for ALL 29 PICS, shuffled
            picsColorMap = {};
            const shuffledAllPicsData = [...allPicsData].sort(() => 0.5 - Math.random());
            shuffledAllPicsData.forEach((item, index) => {
                picsColorMap[item.name] = picsColors[index % picsColors.length]; // Cycle through colors
            });

            // Shuffle allPicsData and take the first `cardSize` (25) unique items for the card
            const cardPicsData = [...allPicsData].sort(() => 0.5 - Math.random()).slice(0, cardSize);

            if (cardPicsData.length < cardSize) {
                 console.error("Erro: N√£o h√° PICS suficientes para gerar um cart√£o 5x5.");
                 alert("Erro: N√£o h√° PICS suficientes para gerar um cart√£o completo (25 itens).");
                 return;
            }

            cardPicsData.forEach((picsData, index) => {
                // Create cell for the main bingo grid
                const cell = document.createElement('div');
                cell.classList.add('card-cell');
                cell.textContent = picsData.name;
                cell.dataset.picsName = picsData.name;
                cell.dataset.index = index;
                cell.addEventListener('click', handleCellClick);
                cardGridElement.appendChild(cell);

                playerCard.push({
                    name: picsData.name,
                    description: picsData.description,
                    marked: false,
                    element: cell, // Reference to grid cell
                    row: Math.floor(index / 5),
                    col: index % 5
                });
            });
             console.log(`Novo cart√£o 5x5 gerado com ${playerCard.length} PICS.`);
        }

        // --- Card Cell Click (Open Expanded View) --- - KEPT SAME BEHAVIOR
        function handleCellClick(event) {
             if (isExpandedViewOpen) return;

            const clickedCell = event.target;
             // Prevent opening if already marked - info is in the sidebar now
             if (clickedCell.classList.contains('marked')) {
                 console.log("Clicou em uma PICS j√° marcada na cartela. Veja a lista ao lado para os detalhes.");
                 return;
             }

            const picsName = clickedCell.dataset.picsName;
            const cardItem = playerCard.find(item => item.name === picsName);

            if (!cardItem) {
                console.error("Erro: Item do cart√£o n√£o encontrado para a PICS:", picsName);
                return;
            }

            currentExpandedCardItem = cardItem;

            showExpandedView(cardItem);
        }

        // --- Expanded View Logic --- - KEPT SAME BEHAVIOR
        function showExpandedView(cardItem) {
            isExpandedViewOpen = true;

            expandedFront.textContent = cardItem.name;
            expandedBack.textContent = cardItem.description;

            const color = picsColorMap[cardItem.name] || '#007bff';
             expandedCardContainer.style.backgroundColor = color;
             expandedFront.style.borderColor = color;
             expandedFront.style.color = color;
             expandedBack.style.borderColor = '#ccc';

            // Update the mark button state
            if (cardItem.marked) {
                 markButton.textContent = 'Marcada';
                 markButton.disabled = true;
                 markButton.style.backgroundColor = '#6c757d'; // Grey
            } else {
                 markButton.textContent = 'Marcar PICS';
                 markButton.disabled = false;
                 markButton.style.backgroundColor = '#28a745'; // Green
            }

            flipContainer.classList.remove('flipped');

            expandedViewOverlay.style.display = 'flex';

             console.log(`Visualizando: ${cardItem.name}. Marcada: ${cardItem.marked}.`);
        }

        function hideExpandedView() {
            isExpandedViewOpen = false;
            currentExpandedCardItem = null;

            expandedViewOverlay.style.display = 'none';
             console.log("Visualiza√ß√£o expandida fechada.");
        }

        function toggleFlip(event) {
            if (event.target === closeExpandedViewButton || event.target === markButton) {
                return;
            }
             console.log('Expanded Card Container clicked! Toggling flip.');
            flipContainer.classList.toggle('flipped');
        }

        // --- Mark Button Logic --- - MODIFIED
        function handleMarkButtonClick() {
            if (!currentExpandedCardItem) {
                 console.error("Bot√£o marcar clicado sem item expandido selecionado.");
                return;
            }

            const cardItem = currentExpandedCardItem;

            if (cardItem.marked) {
                 console.log(`${cardItem.name} j√° est√° marcada.`);
                 return;
            }

            const patternsBeforeMark = checkWinPatterns();

            // --- Mark the item ---
            cardItem.marked = true;
            console.log(`"${cardItem.name}" marcada.`);

            // Apply visual marked styles to the cell element on the grid
            const cellElement = cardItem.element;
            const color = picsColorMap[cardItem.name] || '#007bff';
            cellElement.style.backgroundColor = color;
            cellElement.style.borderColor = color;
            cellElement.style.color = '#ffffff';
            cellElement.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)';
            cellElement.style.boxShadow = `0 0 10px ${color}`;
            cellElement.classList.add('marked'); // Add marked class
            cellElement.style.backgroundImage = 'none';

            // Add the marked item to the sidebar accordion <-- NEW/UPDATED
             addMarkedPicToSidebar(cardItem);


            // Update the mark button state in the expanded view
             markButton.textContent = 'Marcada';
             markButton.disabled = true;
             markButton.style.backgroundColor = '#6c757d';

            // --- Check patterns AFTER marking ---
            const patternsAfterMark = checkWinPatterns();

            // --- Identify NEWLY completed patterns and alert ---
            const newlyCompletedPatterns = patternsAfterMark.filter(p => !completedPatterns.includes(p));

            newlyCompletedPatterns.forEach(pattern => {
                if (pattern.startsWith('row-')) {
                    const row = parseInt(pattern.split('-')[1]) + 1;
                    alert(`üéâ BINGO! Voc√™ completou a Linha ${row}!`);
                } else if (pattern.startsWith('col-')) {
                    const col = parseInt(pattern.split('-')[1]) + 1;
                    alert(`üéâ BINGO! Voc√™ completou a Coluna ${col}!`);
                } else if (pattern === 'diag-1') {
                    alert("üéâ BINGO! Voc√™ completou a Diagonal Principal!");
                } else if (pattern === 'diag-2') {
                    alert("üéâ BINGO! Voc√™ completou a Diagonal Secund√°ria!");
                } else if (pattern === 'blackout') {
                    alert("ü•≥ CARTELA COMPLETA! Parab√©ns, voc√™ marcou todas as PICS!");
                }
            });

            completedPatterns = patternsAfterMark;

            // Optionally close the expanded view after marking
            // hideExpandedView();
        }

        // --- Add Marked PIC to Sidebar Accordion --- <-- PROVIDED & INTEGRATED
        function addMarkedPicToSidebar(cardItem) {
            const accordionItem = document.createElement('div');
            accordionItem.classList.add('accordion-item');

            const color = picsColorMap[cardItem.name] || '#007bff';
            accordionItem.style.borderLeftColor = color;

            const header = document.createElement('div');
            header.classList.add('accordion-header');
            header.textContent = cardItem.name;
            accordionItem.appendChild(header);

            const content = document.createElement('div');
            content.classList.add('accordion-content');
            content.textContent = cardItem.description;
            accordionItem.appendChild(content);

            header.addEventListener('click', () => {
              // Close all other accordion items
              document.querySelectorAll('.accordion-item').forEach(item => {
                if (item !== accordionItem) {
                  item.classList.remove('active');
                }
              });
              // Toggle the active state of the clicked item
              accordionItem.classList.toggle('active');
            });

            markedPicsListElement.appendChild(accordionItem); // Use the correct list element
            console.log(`"${cardItem.name}" adicionada √† lista de marcadas (accordion).`);
        }


        // --- Check all possible win patterns --- - KEPT THE SAME
        function checkWinPatterns() {
            const currentCompleted = [];

            const markedGrid = Array(5).fill(null).map(() => Array(5).fill(false));
            playerCard.forEach(item => {
                if (item.marked) {
                    markedGrid[item.row][item.col] = true;
                }
            });

            // Check Rows
            for (let r = 0; r < 5; r++) {
                let rowComplete = true;
                for (let c = 0; c < 5; c++) {
                    if (!markedGrid[r][c]) {
                        rowComplete = false;
                        break;
                    }
                }
                if (rowComplete) {
                    currentCompleted.push(`row-${r}`);
                }
            }

            // Check Columns
            for (let c = 0; c < 5; c++) {
                let colComplete = true;
                for (let r = 0; r < 5; r++) {
                    if (!markedGrid[r][c]) {
                        colComplete = false;
                        break;
                    }
                }
                if (colComplete) {
                     currentCompleted.push(`col-${c}`);
                }
            }

            // Check Diagonal 1
            let diag1Complete = true;
            for (let i = 0; i < 5; i++) {
                if (!markedGrid[i][i]) {
                    diag1Complete = false;
                    break;
                }
            }
            if (diag1Complete) {
                 currentCompleted.push('diag-1');
            }

            // Check Diagonal 2
            let diag2Complete = true;
            for (let i = 0; i < 5; i++) {
                if (!markedGrid[i][4 - i]) {
                    diag2Complete = false;
                    break;
                }
            }
            if (diag2Complete) {
                 currentCompleted.push('diag-2');
            }

            // Check Blackout
            const allMarked = playerCard.length > 0 && playerCard.every(item => item.marked);
            if (allMarked) {
                currentCompleted.push('blackout');
            }

            return currentCompleted;
        }

        // --- Restart Game (Generate New Card) --- - MODIFIED
        function restartGame() {
             console.log("Reiniciando jogo e gerando novo cart√£o...");

            cardGridElement.innerHTML = ''; // Clear grid display
            markedPicsListElement.innerHTML = ''; // <-- Clear marked list (accordion)
            playerCard = [];
            completedPatterns = [];

            hideExpandedView();

            generateCard();
        }

        // --- Initialization --- - KEPT SAME
        document.addEventListener('DOMContentLoaded', () => {
            restartGame(); // Use restartGame for initial setup

            restartButton.addEventListener('click', restartGame);
            closeExpandedViewButton.addEventListener('click', hideExpandedView);
            expandedCardContainer.addEventListener('click', toggleFlip);
            markButton.addEventListener('click', handleMarkButtonClick);

             expandedViewOverlay.addEventListener('click', (event) => {
                 if (event.target === expandedViewOverlay) {
                     hideExpandedView();
                 }
             });

            // No need for sidebar item specific listeners now, accordion handles clicks internally
        });
    </script>
</body>
</html>